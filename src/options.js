var codes = {"Albania":{"AMC":"27601","Eagle Mobile":"27603","Plus":"27604","Vodafone":"27602"},"Algeria":{"Djezzy":"60302","Mobilis":"60301","Nedjma":"60303"},"Angola":{"Unitel":"63102"},"Antigua":{"APUA":"344030","Digicel":"338050","LIME":"344920"},"Arab Emirates":{"du":"42403","Etisalat":"42402"},"Argentina":{"Claro":"722330","Movistar":"722010","Nextel":"722020","Personnal":"722341"},"Armenia":{"Beeline":"28301","Orange":"28310","VivaCell":"28305"},"Aruba":{"Digicel":"36302","SETAB":"36301"},"Australia":{"OneTel":"50509","Optus":"50502","Telstra Mobile":"50502","Vodafone":"50503"},"Austria":{"3AT":"23210","Mobilkom":"23101","T-Mobile":"23203","Tele.ring":"23205"},"Azerbaijan":{"Azercell":"40001","Bakcell":"40002","FONEX":"40003","Nar Mobile":"40004"},"Bahamas":{"BaTelCo":"364390"},"Bahrain":{"BaTelCo":"42601","VIVA":"42604","zain BH":"42602"},"Bangladesh":{"Airtel":"47006","Banglalink":"47003","CityCell":"47005","Gremenphone":"47001","Robi":"47002","TeleTalk":"47004","Warid Telecom":"47007"},"Belarus":{"DIALLOG":"25703","Life":"25704","MTS":"25702","Velcom":"25701"},"Belgium":{"Base":"20620","Mobistar":"20610","Proximus":"20601","Telenet":"20605"},"Belize":{"Digicell":"70267","Smart":"70299"},"Benin":{"BBCOM":"BBCOM","Glo":"61605","Libercom":"61601","Moov":"61602","MTN":"61603"},"Bolivia":{"Encel":"73602","Nuavatel":"73601","Tigo":"73603"},"Bosnia-Herzegovina":{"BH Mobile":"21890","HT-ERONET":"21803","m:tel":"21805"},"Botswana":{"BTC Mobile":"65203","Mascom":"65201","Orange":"65202"},"Brazil":{"Claro":"72405","Oi":"72431","TIM":"72402","Vivo":"72406"},"Bulgaria":{"Globul":"28405","M-Tel":"28401","Vivatel":"28401"},"Burkina Faso":{"Telecel Faso":"61303","Telmob":"61301","Zain":"61302"},"Burundi":{"Africell":"64202","Omatel":"64203","Smart Mobile":"64207","Spacetel":"64201","U-COM Burundi":"64282"},"Cambodia":{"Beeline":"45609","hello":"45602","Metfone":"45608","Mfone":"45618","Mobitel":"45601","qb":"45604","Smart Mobile":"45606","Star-Cell":"45605"},"Cameroon":{"MTN Cameroon":"62401","Orange":"62402"},"Canada":{"Fido Canada":"30200001","MicroCell":"302370","Rogers A&T":"302720","Telus":"302220"},"Cap Verde":{"CVMOVEL":"62501","T+":"62502"},"Chile":{"Claro":"73003","Entel":"73001","Movistar":"73002","Nextel":"73009","VTR Movil":"73005","Will":"73099"},"China":{"China Mobile":"46000","China Telecom":"46005","China Tietong":"46020","China Unicom":"46001"},"Colombia":{"Movistar":"732102","Tigo":"732111"},"Columbia":{"Comcel":"732101","Edatel":"732002"},"Costa Rica":{"ICE":"71203"},"Cote Ivore":{"Koz":"61204","Moov":"61204"},"Croatia":{"T-Mobile":"21901","Tele2":"21902","VIPNet":"21910"},"Cyprus":{"MTN":"28010","Vodafone":"28001"},"Czech Republic":{"O2":"23002","T-Mobile":"23001","Vodafone":"23003"},"Denmark":{"Debitel":"23800001","Denmark Mobil":"23801","Orange":"23830","Sonofon":"23802","Telia Denmark":"23820"},"Dominican Republic":{"Claro":"37002","Orange":"37001","Tricom":"37003","Viva":"37004"},"Ecuador":{"Alegro":"74002","Movistar":"74000","Porta":"74001"},"Egypt":{"Etisalat":"60203","Mobinil":"60201","Vodafone":"60202"},"El Salvador":{"Claro":"70611","CTE Telecom":"70601","Digicel":"70602","Movistar":"70604","Tigo":"70603"},"Estonia":{"Elisa":"24802","EMT":"24801","Estonian Mobile":"24801","RadioLinja":"24802","Tele 2":"24803"},"Fiji":{"Digicel":"54202","Vodafone":"54201"},"Finland":{"2G":"24412","AMT":"24414","Finnet Group":"24409","Radjolinja":"24405","Sonera Corp.":"24409","Telia Finland":"24403"},"France":{"Bouygues Telecom":"20820","Orange":"20801","SFR":"20810"},"Gabon":{"Airtel":"62803","Azur":"62804","Liberts":"62801","Moov":"62802"},"Georgia":{"Beeline":"28204","Geocell":"28201","Iberiatel":"28203","MagtiCom":"28202","SILKNET":"28205"},"Germany":{"E-Plus":"26203","MobilCom":"26213","O2":"26207","Quam":"26214","T-Mobile":"26201","Vodafone":"26202"},"Ghana":{"Airtel":"62006","MTN":"62001","tiGO":"62003","Vodafone":"62002"},"Greece":{"Cosmote":"20201","Telestet":"20210","Vodafone":"20205","Wind":"20209"},"Guatemala":{"Claro":"70401","Comcel\/Tigo":"70402","Movistar":"70403"},"Guinea-Bissau":{"Arreba":"63202","Orange":"63203"},"Haiti":{"Digicel":"37202","Voila":"37201"},"Honduras":{"Claro":"70801","Digicel":"70840","Hondutel":"70830"},"Hong Kong":{"HK Telecom":"45400","Hutchison":"45404","Mandarin Com.":"45416","New World PCS":"45410","P Plus":"45422","Pacific Link":"45418","Peoples Telephone":"45412","Smartone Mobile":"45406"},"Hungary":{"Pannon GSM":"21601","Vodafone":"21670","Westel GSM":"21630"},"Iceland":{"Simmin":"27401","Vodafone":"27402"},"India":{"Airtel Digilink":"40401","Bharti Telecom":"40402","BPL USWest":"40421","BSNL Mobile":"40455","Dolphin":"40468","Escotel Mobile":"40412","Hutch":"40405","Idea":"40422","INA AIRTel":"40440","Ina Spice":"40014","Oasis":"40470","Orange":"40020","Spice":"40441","TATA Cellular":"40407","Usha Martin Tel.":"40426","Ushafon":"40408","Ushafone":"40432","Videocon":"40584"},"Indonesia":{"3":"51089","AXIS":"51008","Ceria":"51027","Fren\/Hepi":"51028","INDOSAT":"51001","PSN":"51000","SMART":"51009","StarOne":"51003","TelkomFlexi":"51007","TELKOMMobile":"51020","Telkomsel":"51010","XL":"51011"},"Ireland":{"Eircom":"27207","Meteor":"27203","O2":"27202","Vodafone":"27201"},"Israel":{"Cellcom":"42502","JAWAL":"42505","Orange":"42501"},"Italy":{"3":"22299","BLU":"22298","Telecom Italia":"22201","Vodafone":"22210","Wind Tel.":"22288"},"Jamaica":{"Claro":"338070","Digicel":"338050","LIME":"338180"},"Japan":{"DoCoMo":"44010","eMobile":"44000","KDDI":"44008","SoftBank":"44004","TU-KA":"44081"},"Jordan":{"Orange":"41677","Umniah":"41603","Xpress Telecom":"41602","zain JO":"41601"},"Kazakhstan":{"Beeline":"40101","Kcell":"40102"},"Kenya":{"Orange Kenya":"63907","Safaricom":"63902","yu":"69305"},"Kuwait":{"Viva":"41904","Wataniya":"41903","zain KW":"41902"},"Kyrgyzstan":{"Beeline":"43701","Fonex":"43703","MegaCom":"43705","O":"43709"},"Laos":{"ETL":"45702","LaoTel":"45701","Tigo":"45708","Unitel":"45703"},"Latvia":{"Latvian Mobile":"24701","Tele 2":"24702"},"Lebanon":{"Alfa":"41501","mtc touch":"41503","Ogero Mobile":"41505"},"Lithuania":{"BITE":"24602","Omnitel":"24601","Tele 2":"24603"},"Luxembourg":{"Luxgsm":"27801","Orange":"27099","Tango":"27077"},"Macedonia":{"ONE":"29402","T-Mobile MK":"29401","VIP MK":"29403"},"Malaysia":{"Celcom":"50219","DiGi":"50216","Maxis":"50212","TM CDMA":"50201","U Mobilz":"50218"},"Mali":{"Malitel":"61001","Orange":"61002"},"Mamibia":{"Leo":"64903","MTC":"64901","Switch":"64902"},"Mexico":{"Lusacell":"33405","Movistar":"33403","Nextel":"33401","Telcel":"33402"},"Moldova":{"IDC":"25903","Moldcell":"25903","Orange":"25901"},"Mongolia":{"G-Mobile":"42898","MobiCom":"42899","Skytel":"42891","Unitel":"42888"},"Morocco":{"IAM":"60401","INWI":"60402","Meditel":"60400"},"Mozambique":{"mCel":"64301","Vodacom":"64304"},"Nepal":{"Namaste\/NT Mobile":"42901","Ncell":"42904","Sky\/C-Phone":"42903","SmartCell":"42904"},"Netherlands":{"6GMobile":"20414","KPN":"20408","Orange":"20420","T-Mobile":"20416","Tele 2":"20402","Telfort":"20412","Vodafone":"20404"},"Netherlands Antilles":{"Bayos":"36294","Digicel":"36269","MIO":"36295","Telcell":"36251","UTS":"36291"},"New Zealand":{"Telecom":"53000","Vodafone":"53001"},"Nicaragua":{"Claro":"71021","Movistar":"71030"},"Niger":{"Airtel":"61402","Orange":"61404","SahelCom":"61401","Telecel":"61403"},"Nigeria":{"Airtel":"62120","Etsalat":"62160","Glo":"62150","M-TEL":"62140","MTN":"62130"},"Norway":{"NetCom":"24202","Telenor":"24201"},"Oman":{"Nawras":"42203","Oman Mobile":"41202"},"Pakistan":{"Mobilink":"41001","Telenor":"41006","Ufone":"41003","Vodafone":"41008","Warid":"41007","Zong":"41004"},"Panama":{"Cable & Wireless":"71401","Claro":"71403","Digicel":"71404","Movistar":"71402"},"Papua New Guinea":{"B-Mobile":"53701","Digicel":"53703"},"Paraguay":{"Claro":"74402","Personal":"74405","Tigo":"74404","VOX":"74406"},"Peru":{"Claro":"71610","Movistar":"21606","NEXTEL":"71607"},"Philippines":{"Globe":"51502","Islacom":"51501","Smart":"51503","Sun":"51505"},"Poland":{"ERA GSM":"26002","IDA Centertel":"26003","Play":"26006","Polkomtel PLUS":"26001"},"Portugal":{"Optimus Telecom":"26803","Telecom Moveis":"26806","Vodafone":"26801"},"Qatar":{"Qtel":"42701","Vodafone":"42702"},"Romania":{"Cosmorom":"22603","Mobifon":"22601","Mobil Rom":"22610"},"Russia":{"BeeLine":"25099","Don Telecom":"25010","Kuban GSM":"25213","Megafon":"25002","MTS Moscow":"25001","New Telephone Cy":"25012","North Caucasian":"25044","Siberian Cellular":"25005","Uratel":"25039","Zao Smarts":"25007"},"Rwanda":{"MTN":"63510","Tigo":"63513"},"Saudi Arabia":{"Al Jawal":"42001","Mobily":"42003","Zain SA":"42004"},"Senegal":{"Expresso":"60803","Orange":"60801","Tigo":"60802"},"Serbia":{"Telekom Srbija":"22003","Telenor":"22001","VIP Mobile":"22005"},"Singapore":{"GSM 1800":"52502","GSM 900":"52501","M1-3GSM":"52504","MobileOne Asia":"52503","StarHub":"52205"},"Slovakia":{"O2":"23106","Orange":"23101","T-Mobile":"23102"},"Slovenia":{"Mobitel":"29341","Si.mobil":"29140","Tusmobil":"29370"},"South Africa":{"Cell C":"65507","MTN":"65510","Vodacom":"65501"},"South Korea":{"KT":"45002","LGT":"45006","Olleh":"45008","Power 017":"45003","SKT":"45005"},"Spain":{"Amena":"21403","Movistar":"21402","Telefonica":"21407","Vodafone":"21401","Xfera":"21404"},"Sri Lanka":{"Airtel":"41305","Dialog":"41302","Etisalat":"41303","Hutch":"41308","Mobitel":"41301"},"Sweden":{"3 Sweden":"24002","Comviq":"24007","Orange":"24003","Telia Mobitel":"24001","Vodafone":"24008"},"Switzerland":{"Orange":"22803","Sunrise":"22802","Swisscom":"22801"},"Taiwan":{"Chunghwa":"46692","Far Eastone":"46601","KG Telecom":"46688","Mobitel":"46693","TINGSM":"46697","TransAsia":"46699","TUNTEX":"46606"},"Tajikistan":{"Babilon-M":"43604","Beeline":"43605","MLT":"43603","Tcell":"43602"},"Tanzania":{"Life":"64007","SasaTel":"64006","tiGO":"64002","Vodacom":"64004","Zantel":"64003"},"Thailand":{"AIS":"52001","DTotal":"52018","GSM 1800":"52023","Orange":"52010"},"Togo":{"Moov":"61503","Togo Cell":"61501"},"Trinidad and Tobago":{"Bmobile":"37412","Digicel":"37413"},"Tunisia":{"Orange":"60501","Tunicell":"60502","Tunisiana":"60503"},"Turkey":{"Avea":"28603","Turkcell":"28601","Vodafone":"28602"},"Turkmenistan":{"MTS":"43801","TM-Cell":"43802"},"Uganda":{"MTN":"64110","Orange":"64114","Warid Telecom":"64122","Zain":"64101"},"Ukraine":{"Beeline":"25502","kylvstar":"25503","Life":"25507","MTS":"25501"},"United Kingdom":{"3":"23420","Guermsey Tel.":"23455","Jersey Telecom":"23450","Manx Pronto":"23450","O2":"23410","Orange":"23433","T-Mobile":"23430","Vodafone":"23415"},"Uruguay":{"Ancel":"74801","Claro":"74810","Movistar":"74807"},"USA":{"Aerial":"31031","AT&T":"31038","BellSouth":"31015","Cingular":"31017","Iowa Wireless":"31077","Powertel":"31027","Sprint":"31002","T-Mobile":"31020","Western Wireless":"31026","Wireless 2000":"31011"},"Uzbekistan":{"Beeline":"73404","MTS":"73407","Ucell":"73405"},"Vietnam":{"3G EVNTelecom":"45208","Beeline VN":"45207","EVNTelecom":"45206","MobiFone":"45201","S-Fone":"45203","Vietnam Mobile":"45205","Viettel Mobile":"45204","Vinaphone":"45202"}};

var resetSimSettings = function()
{
	setSimSettings({
		country: "USA",
		operator: "T-Mobile",
		operatorCode: "31020"
	});
}

var checkSimSettings = function()
{
	if (!localStorage.getItem("simCountry") || !localStorage.getItem("simOperator") || !localStorage.getItem("simOperatorCode"))
	{
		resetSimSettings();
	}
}

var setSimSettings = function(sim)
{
	localStorage.simCountry = sim.country;
	localStorage.simOperator = sim.operator;
	localStorage.simOperatorCode = sim.operatorCode;
}

var initCountryOptions = function()
{
	for (country in codes)
	{
		var opt = document.createElement("option");
		opt.value = country;
		opt.innerHTML = country;
		
		if (country == localStorage.simCountry)
		{
			opt.selected = "selected";
		}
		
		sltCountry.appendChild(opt);
	}
	
	sltCountry.onchange = function(e){
		var country = sltCountry.value;
		
		initOperatorOptions(country);
	};
	
	sltCountry.onchange();
}

var initOperatorOptions = function(country)
{
	// clear all childs
	while(sltOperator.hasChildNodes())
	{
		sltOperator.removeChild(sltOperator.firstChild);
	}            
	
	if (country.length > 0)
	{
		for (operator in codes[country])
		{
			var opt = document.createElement("option");
			opt.value = operator;
			opt.innerHTML = operator;
			
			if (operator == localStorage.simOperator)
			{
				opt.selected = "selected";
			}
			
			sltOperator.appendChild(opt);
		}
	}
}

var showWarning = function()
{
	document.getElementById("warning").style.display = "block";
}

var testSSL = function()
{
	var xhr = new XMLHttpRequest();
	xhr.open("GET", "https://android.clients.google.com/market/api/ApiRequest", true);
	xhr.onreadystatechange = function() {
		if (this.readyState == 4) {
			if (this.status == 0)
			{
				showWarning();
			}
		}
	};
	xhr.send();
}

testSSL();

var saveAuth = function(email, token, deviceId)
{
	localStorage.authEmail = email;
	localStorage.authToken = token;
	localStorage.deviceId = deviceId.toLowerCase();
}

var clearAuth = function()
{
	localStorage.removeItem("authEmail");
	localStorage.removeItem("authToken");
	localStorage.removeItem("deviceId");
}

var login = function(email, password, deviceId) {
	var ACCOUNT_TYPE_HOSTED_OR_GOOGLE = "HOSTED_OR_GOOGLE";
	var URL_LOGIN = "https://www.google.com/accounts/ClientLogin";
	var LOGIN_SERVICE = "androidsecure";

	var params = {
		"Email": email,
		"Passwd": password,
		"service": LOGIN_SERVICE,
		"accountType": ACCOUNT_TYPE_HOSTED_OR_GOOGLE
	};
	
	var xhr = new XMLHttpRequest();
	xhr.open("POST", URL_LOGIN, true);
	
	var paramsStr = "";
	for (key in params)
	{
		paramsStr += "&" + key + "=" + encodeURIComponent(params[key])
	}
	
	xhr.onreadystatechange = function() {
		if (this.readyState == 4) {
			var AUTH_TOKEN = "";
			var response = this.responseText;
			
			if (response.indexOf("Error") > -1)
			{
				alert('ERROR: Invalid email or password!');
				return;
			}
			
			var regex = /Auth=([a-z0-9=_\-]+)/gi;
			match = regex.exec(response);
			if (match && match.length >= 1)
			{
				AUTH_TOKEN = match[1];
			}
			
			if (!AUTH_TOKEN)
			{
				alert('ERROR: Cannot use this email');
				return;
			}
			
			saveAuth(email, AUTH_TOKEN, deviceId);
			refreshViews();
		}
	}
	
	xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhr.send(paramsStr);
}

var refreshViews = function()
{
	if (typeof localStorage.authToken == "undefined")
	{
		txtAuthEmail.innerHTML = "";
		txtDeviceId.innerHTML = "";
		formLogin.style.display = "block";
		formInfo.style.display = "none";
	}
	else
	{
		txtAuthEmail.innerHTML = localStorage.authEmail;
		txtDeviceId.innerHTML = localStorage.deviceId.toUpperCase();
		
		formInfo.style.display = "block";
		formLogin.style.display = "none";
		
		checkSimSettings();
		initCountryOptions();
	}
}

var formInfo = document.getElementById("info_form");
var formLogin = document.getElementById("login_form");

var txtAuthEmail = document.getElementById("auth_email");
var txtDeviceId = document.getElementById("device_id");

var inpEmail = document.getElementById("user_email");
var inpPassword = document.getElementById("user_password");
var inpDeviceId = document.getElementById("user_device_id");

var sltCountry = document.getElementById("slt_country");
var sltOperator = document.getElementById("slt_operator");
var btnDefault = document.getElementById("btn_default");
btnDefault.onclick = function(e) {
	e.preventDefault();
	if (confirm('Reset to default sim operator?'))
	{
		resetSimSettings();
		initCountryOptions();
	}
}

var btnSave = document.getElementById("btn_save");
btnSave.onclick = function(e) {
	e.preventDefault();
	var country = sltCountry.value;
	var operator = sltOperator.value;
	var operatorCode = codes[country][operator];
	setSimSettings({
		country: country,
		operator: operator,
		operatorCode: operatorCode
	});
	alert('Save successfully!');
}

var btnLogin = document.getElementById("btn_login");
btnLogin.onclick = function(e){
	e.preventDefault();
	
	var email = inpEmail.value;
	var password = inpPassword.value;
	var deviceId = inpDeviceId.value;
	
	if (email.length == 0)
	{
		alert('ERROR: Please enter Email!');
		inpEmail.focus();
		return;
	}
	else if (password.length == 0)
	{
		alert('ERROR: Please enter Password!');
		inpPassword.focus();
		return;
	}
	else if (deviceId.length == 0)
	{
		alert('ERROR: Please enter your Android Device ID!');
		inpDeviceId.focus();
		return;
	}
	
	var match = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.exec(email);
	if (!match)
	{
		alert('ERROR: Please enter valid email!');
		return;
	}
	
	if (deviceId.length != 16 || !/^[0-9a-f]+$/i.exec(deviceId))
	{
		alert('ERROR: Android Device ID must be 16 characters long and only contains characters from 0-9, A-F');
		return;
	}
	
	login(email, password, deviceId);
};

var btnLogout = document.getElementById("btn_logout");
btnLogout.onclick = function(e)	{
	e.preventDefault();
	
	if (confirm('Change another email?'))
	{
		clearAuth();
		refreshViews();
	}
}

refreshViews();